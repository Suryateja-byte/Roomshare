# Playwright Test Plan: Priority 3 E2E Coverage Gaps

**Date**: 2026-02-14
**Feature**: Close E2E coverage gaps for Settings, Profile, Admin Actions, Notifications, Saved Searches, Recently Viewed
**Author**: Generated by Playwright Test Planner Skill
**Status**: Approved

---

## 1. Scope & Context

### Feature Description

Expand E2E test coverage to under-tested areas of Roomshare to gain ship confidence. Four areas selected based on production risk: Profile & Settings, Admin Verifications & Audit, Notifications, and Saved Searches & Recently Viewed.

### User Personas

- **Primary**: Authenticated tenant managing their account (profile, settings, notifications, saved searches)
- **Secondary**: Admin user reviewing verifications and audit logs
- **Edge**: Unauthenticated user hitting protected routes

### Critical User Journeys

1. User edits profile (name, bio, avatar, languages) -> saves -> verifies changes persist
2. User changes settings (notifications, password, blocked users, account deletion)
3. Admin reviews pending verification -> approves/rejects -> action logged in audit
4. User manages notifications (mark read, delete, filter, bulk actions)
5. User manages saved searches (view, toggle alerts, delete) + reviews recently viewed

### Tech Stack

- **Frontend**: Next.js 16.1.6 (App Router), React, TypeScript
- **Backend**: Next.js API routes, Prisma 6.0, PostgreSQL + PostGIS
- **Auth**: NextAuth.js 5.0.0-beta.30 (session-based)
- **Testing**: Playwright 1.57, 5 CI shards, 10 browser projects

### Risk Assessment

| Area | Business Impact | Blast Radius | Rollback |
|------|----------------|-------------|----------|
| Profile/Settings broken | HIGH - users can't manage accounts | All authenticated users | Feature-level revert |
| Admin verifications broken | HIGH - trust pipeline stalls | All new verifications | Feature-level revert |
| Notifications broken | MEDIUM - users miss alerts | All authenticated users | Feature-level revert |
| Saved searches/recently viewed | LOW - convenience features | Users with saved data | Feature-level revert |

### Calibration (Shield Layer Depth)

| Area | Functional | Resilience | A11y | Visual | Perf | Cross-Platform |
|------|-----------|-----------|------|--------|------|---------------|
| Settings (form/data) | Deep | Medium | Deep | Skip | Skip | Medium |
| Profile Edit (form) | Deep | Medium | Deep | Skip | Skip | Medium |
| Admin Verifications | Medium | Skip | Skip | Skip | Skip | Light |
| Admin Audit | Light | Skip | Skip | Skip | Skip | Light |
| Notifications Extended | Medium | Medium | Light | Skip | Skip | Light |
| Saved Searches | Medium | Skip | Skip | Skip | Skip | Light |
| Recently Viewed | Light | Skip | Skip | Skip | Skip | Light |

---

## 2. Test Architecture

### Directory Structure

```
tests/e2e/
+-- settings/
|   +-- settings.spec.ts              # ST-01..ST-18
+-- profile/
|   +-- profile-edit.spec.ts          # PE-01..PE-15
+-- admin/
|   +-- admin-actions.spec.ts         # AA-01..AA-16 (serial mutations)
+-- notifications/
|   +-- notifications-extended.spec.ts # NX-01..NX-10
+-- saved/
|   +-- saved-searches.spec.ts        # SS-01..SS-10
+-- recently-viewed/
    +-- recently-viewed.spec.ts       # RV-01..RV-08
```

### Conventions (match existing codebase)

- **Imports**: `import { test, expect, timeouts } from "../helpers";`
- **Admin tests**: `import { test, expect } from '@playwright/test';` (runs under chromium-admin project)
- **Test IDs**: 2-letter prefix + number (ST-01, PE-01, AA-01, NX-01, SS-01, RV-01)
- **Auth**: `test.use({ storageState: "playwright/.auth/user.json" })` for user tests
- **Slow pages**: `test.slow()` in beforeEach for SSR pages
- **Test ordering**: Read-only tests first, then `test.describe.serial()` for mutation blocks
- **Assertions**: Web-first assertions throughout (no `waitForTimeout`)
- **Map mocking**: Auto-applied via test fixture (no action needed)

### No New Infrastructure

Reuses existing helpers:
- `nav.goToSettings()`, `nav.goToProfile()`, `nav.goToSavedSearches()`, `nav.goToNotifications()`
- `test`, `expect`, `timeouts`, `selectors`, `tags` from `../helpers`
- `A11Y_CONFIG` for axe-core scans
- Auth states: `user.json`, `admin.json`

---

## 3. Functional Test Matrix

### Tier 1A: `settings.spec.ts` (18 tests)

| ID | User Journey | Steps | Key Assertions | Priority |
|----|-------------|-------|----------------|----------|
| ST-01 | Unauth redirect | Goto /settings without auth | Redirects to /login | P0 |
| ST-02 | Page renders all sections | Goto /settings | Heading visible, 3 sections: Notifications, Password, Account | P0 |
| ST-03 | Notification toggle ON | Click toggle ON -> Save Preferences | Toast success, preference persists after reload | P0 |
| ST-04 | Notification toggle OFF | Click toggle OFF -> Save Preferences | Toast success, toggle state persists after reload | P0 |
| ST-05 | Multiple toggles save atomically | Toggle 3 preferences -> Save | All 3 persist after reload | P1 |
| ST-06 | Save disabled when no changes | Load page, don't change anything | Save Preferences button disabled | P1 |
| ST-07 | Change password happy path | Fill current + new + confirm -> Submit | Success message, form clears | P0 |
| ST-08 | Change password - wrong current | Fill wrong current password -> Submit | Error: incorrect password | P0 |
| ST-09 | Change password - mismatch | Fill mismatched new/confirm -> Submit | Error: passwords don't match | P0 |
| ST-10 | Change password - weak | Fill weak new password | PasswordStrengthMeter shows weak, validation error on submit | P1 |
| ST-11 | Blocked users list visible | Navigate to settings (seeded blocked user) | Blocked user card with avatar + Unblock button visible | P1 |
| ST-12 | Unblock user | Click Unblock button | User removed from blocked list | P1 |
| ST-13 | Delete account - button visible | Find Delete My Account section | Red button visible in Account section | P0 |
| ST-14 | Delete account - confirmation gate | Click Delete -> type wrong text | "Delete Forever" button stays disabled | P0 |
| ST-15 | Delete account - type DELETE | Click Delete -> type "DELETE" | "Delete Forever" button becomes enabled | P1 |
| ST-16 | A11y: keyboard navigation | Tab through all interactive elements | Focus order logical, all toggles reachable | P1 |
| ST-17 | A11y: axe scan | Run axe-core on settings page | Zero WCAG 2.1 AA violations | P1 |
| ST-18 | Resilience: API 500 on save | Mock preferences API -> 500 | Error toast, toggles revert | P1 |

### Tier 1B: `profile-edit.spec.ts` (15 tests)

| ID | User Journey | Steps | Key Assertions | Priority |
|----|-------------|-------|----------------|----------|
| PE-01 | View own profile | Goto /profile | data-testid="profile-page" visible, name + bio displayed | P0 |
| PE-02 | Edit link navigates | Click data-testid="edit-profile-link" | Navigates to /profile/edit | P0 |
| PE-03 | Edit form pre-filled | Goto /profile/edit | data-testid="profile-name-input" contains current name | P0 |
| PE-04 | Update display name | Change name -> click Save | Success, redirect to /profile, new name visible | P0 |
| PE-05 | Update bio | Enter new bio -> Save | Success, bio visible on profile page | P0 |
| PE-06 | Bio character limit | Type 501 chars | Counter shows 501/500, save disabled or validation error | P1 |
| PE-07 | Empty name validation | Clear name -> Save | Validation error, form not submitted | P0 |
| PE-08 | Cancel discards changes | Change name -> Cancel | Returns to /profile, original name displayed | P0 |
| PE-09 | Changes persist after reload | Update name -> reload /profile | Updated name still displayed | P0 |
| PE-10 | Add language | Click Add -> type language -> confirm | Language tag appears in list | P1 |
| PE-11 | Remove language | Click X on language tag | Language removed | P1 |
| PE-12 | Upload avatar | Upload valid image | Avatar updates, upload indicator shown | P1 |
| PE-13 | Public profile view | Navigate to /users/{userId} | Profile visible, no edit button | P1 |
| PE-14 | A11y: form labels & focus | Axe scan + keyboard test | Inputs labeled, focus management on save/error | P1 |
| PE-15 | Resilience: API 500 on save | Mock update profile -> 500 | Error message, form data preserved | P1 |

### Tier 1C: `admin-actions.spec.ts` (16 tests)

Runs under `chromium-admin` project. Mutation tests use `test.describe.serial()`.

| ID | User Journey | Steps | Key Assertions | Priority |
|----|-------------|-------|----------------|----------|
| AA-01 | Verification list renders | Goto /admin/verifications | Pending requests with document info visible | P0 |
| AA-02 | Filter: Pending | Click Pending tab | Only PENDING items shown | P0 |
| AA-03 | Filter: Approved | Click Approved tab | Only APPROVED items shown | P1 |
| AA-04 | Filter: Rejected | Click Rejected tab | Only REJECTED items shown | P1 |
| AA-05 | Approve verification | Click Approve on pending | Status -> APPROVED, success feedback | P0 |
| AA-06 | Reject - opens reason input | Click Reject on pending | Reason input + Confirm/Cancel visible | P0 |
| AA-07 | Reject with reason | Enter reason -> Confirm Reject | Status -> REJECTED, reason displayed | P0 |
| AA-08 | Cancel reject | Click Reject -> Cancel | Returns to initial state | P1 |
| AA-09 | Audit log renders | Goto /admin/audit | Heading + table with entries displayed | P0 |
| AA-10 | Audit filter by action type | Click action type button | Table filters to matching type | P1 |
| AA-11 | Audit entries show columns | Inspect table row | Action, Admin, Target, Details, Time present | P1 |
| AA-12 | Audit pagination | Click Next | New entries, page indicator updates | P1 |
| AA-13 | Admin action -> audit entry | Approve verification -> visit audit | New entry for approval action | P0 |
| AA-14 | Non-admin blocked | Visit /admin as user.json auth | Redirect or 403 | P0 |
| AA-15 | Unauthenticated blocked | Visit /admin without auth | Redirect to /login | P0 |
| AA-16 | View documents | Click "View Document" link | Opens in new tab | P1 |

### Tier 2A: `notifications-extended.spec.ts` (10 tests)

Extends existing `notifications.spec.ts` (NF-01..NF-14) with uncovered flows.

| ID | User Journey | Steps | Key Assertions | Priority |
|----|-------------|-------|----------------|----------|
| NX-01 | Delete all - confirmation dialog | Click "Delete all" | Dialog appears with notification count | P0 |
| NX-02 | Delete all - confirm | Confirm in dialog | All removed, empty state shown | P0 |
| NX-03 | Delete all - cancel | Cancel in dialog | Notifications unchanged | P1 |
| NX-04 | Load more pagination | Click Load More (if >20) | Additional notifications appended | P1 |
| NX-05 | Notification type icons | Check various types | Correct color/icon per type | P1 |
| NX-06 | Click notification navigates | Click notification with link | Navigates to /bookings, /messages, etc. | P0 |
| NX-07 | Unread count decrements | Mark one as read | Unread count - 1 | P0 |
| NX-08 | Mark all read + unread filter | Mark all read -> Unread tab | "No unread notifications" | P1 |
| NX-09 | Resilience: API 500 on delete | Mock delete -> 500 | Error, notification stays | P1 |
| NX-10 | A11y: keyboard navigation | Tab through list | Items reachable, buttons focusable | P1 |

### Tier 2B: `saved-searches.spec.ts` (10 tests)

| ID | User Journey | Steps | Key Assertions | Priority |
|----|-------------|-------|----------------|----------|
| SS-01 | Unauth redirect | Goto /saved-searches without auth | Redirects to /login | P0 |
| SS-02 | Page renders | Goto /saved-searches | Heading + search cards | P0 |
| SS-03 | Empty state | User with no saved searches | "No saved searches yet" + Start Searching link | P0 |
| SS-04 | View saved search | Click View button | Navigates to /search with filters in URL | P0 |
| SS-05 | Toggle alert on | Click bell icon (off) | Bell turns green, "Alerts enabled" badge | P1 |
| SS-06 | Toggle alert off | Click bell icon (on) | Bell turns gray, badge removed | P1 |
| SS-07 | Delete - confirm | Click delete -> confirm | Search removed from list | P0 |
| SS-08 | Delete - cancel | Click delete -> cancel | Search still present | P1 |
| SS-09 | Filter summary | View search with filters | Correct filter text displayed | P1 |
| SS-10 | Persistence after reload | Toggle alert -> reload | State persisted | P1 |

### Tier 3: `recently-viewed.spec.ts` (8 tests)

| ID | User Journey | Steps | Key Assertions | Priority |
|----|-------------|-------|----------------|----------|
| RV-01 | Unauth redirect | Goto /recently-viewed without auth | Redirects to /login | P0 |
| RV-02 | Page renders | Goto /recently-viewed | Heading + listing cards | P0 |
| RV-03 | Empty state | No recently viewed | "No recent activity" + Start exploring link | P0 |
| RV-04 | Click listing navigates | Click card | Navigates to /listings/{id} | P0 |
| RV-05 | Time badges | View cards | "Just now", "2h ago" badges visible | P1 |
| RV-06 | Image error handling | Card with broken image | "No Photos" placeholder, no crash | P1 |
| RV-07 | Start exploring link | Click from empty state | Navigates to /search | P1 |
| RV-08 | Find more button | Click "Find more" | Navigates to /search | P1 |

---

## 4. Resilience Test Matrix

Embedded in functional specs (ST-18, PE-15, NX-09). Kept light per calibration.

| ID | Category | Failure Scenario | Mock/Setup | Expected Behavior | Priority |
|----|----------|-----------------|------------|-------------------|----------|
| ST-18 | API Failure | Settings save returns 500 | `page.route -> 500` | Error toast, toggles revert | P1 |
| PE-15 | API Failure | Profile update returns 500 | `page.route -> 500` | Error message, form preserved | P1 |
| NX-09 | API Failure | Notification delete returns 500 | `page.route -> 500` | Error, notification stays | P1 |

---

## 5. Accessibility Test Plan

### WCAG Compliance Target: AA

### Automated Scans (axe-core)

| Page/State | Trigger | Tags | Exclusions |
|-----------|---------|------|------------|
| Settings page | Navigate to /settings | wcag2a, wcag2aa, wcag21a, wcag21aa | A11Y_CONFIG.globalExcludes |
| Profile edit form | Navigate to /profile/edit | wcag2a, wcag2aa, wcag21a, wcag21aa | A11Y_CONFIG.globalExcludes |

### Keyboard Navigation Flows

| Flow | Test ID | Steps | Focus Assertions |
|------|---------|-------|-----------------|
| Settings toggles | ST-16 | Tab through toggles, buttons | All interactive elements reachable |
| Profile form | PE-14 | Tab through inputs, buttons | Focus on error after validation failure |
| Notification list | NX-10 | Tab through notification items | Action buttons focusable |

---

## 6. Visual Regression Plan

**Skipped.** Internal user/admin pages -- low ROI for visual regression. Can be added as Phase 2 if needed.

---

## 7. Performance Budget Table

**Skipped.** Internal pages with low traffic. Performance testing exists for search/map pages which are higher priority.

---

## 8. Cross-Platform Matrix

Uses existing Playwright projects -- no changes needed.

| Project | Browser | Viewport | Auth State | Tests |
|---------|---------|----------|-----------|-------|
| chromium | Chromium | Desktop | user.json | All ST, PE, NX, SS, RV |
| firefox | Firefox | Desktop | user.json | All ST, PE, NX, SS, RV |
| webkit | WebKit | Desktop | user.json | All ST, PE, NX, SS, RV |
| Mobile Chrome | Chromium | 412x915 | user.json | All ST, PE, NX, SS, RV |
| Mobile Safari | WebKit | 390x844 | user.json | All ST, PE, NX, SS, RV |
| chromium-admin | Chromium | Desktop | admin.json | All AA tests |

---

## 9. CI/CD Quality Gate

**No config changes needed.** Tests distribute across existing 5 shards.

Estimated impact: ~15 tests/shard (77 total), adding ~2-3 min/shard with `test.slow()`.

| Test Layer | Blocks Deploy? | Retry Policy |
|-----------|---------------|-------------|
| Functional (all) | Yes | 2 retries in CI |
| Resilience (3 tests) | Yes | 2 retries in CI |
| A11y (3 tests) | Yes | 2 retries in CI |

---

## 10. Implementation Priority

| Phase | Tier | Files | Tests | Coverage Gain |
|-------|------|-------|-------|---------------|
| Phase 1 | T1 | settings.spec.ts, profile-edit.spec.ts, admin-actions.spec.ts | 49 | Profile/settings + admin actions (highest risk) |
| Phase 2 | T2 | notifications-extended.spec.ts, saved-searches.spec.ts | 20 | Notifications + saved searches (medium risk) |
| Phase 3 | T3 | recently-viewed.spec.ts | 8 | Recently viewed (lowest risk) |

**Total: 77 tests across 6 spec files**

---

## Seed Data Requirements

The following seed data must exist for tests to pass:

- **Test user** (e2e-test@roomshare.dev): Has profile data, notification preferences, blocked users, saved searches, recently viewed listings, notifications of various types
- **Admin user** (e2e-admin@roomshare.dev): Has admin role, access to /admin routes
- **Verification requests**: At least 1 PENDING, 1 APPROVED, 1 REJECTED with documents
- **Audit log entries**: At least 5 entries across different action types
- **Notifications**: At least 4 of different types (booking, message, review, search alert), mix of read/unread
- **Saved searches**: At least 2 with different filter combinations, 1 with alerts enabled
- **Recently viewed**: At least 3 listings with different view timestamps

Review seed script (`scripts/seed-e2e.js`) and extend if any of the above is missing.

---

## Open Questions

- [ ] Does the seed script already create blocked users for the test user? If not, seed extension needed for ST-11/ST-12.
- [ ] Admin action tests (AA-05, AA-07) mutate verification state. Should we add a seed-reset step between admin test runs, or accept that admin tests run in a specific order (serial)?
- [ ] For PE-12 (avatar upload): does the `/api/upload` endpoint work in CI without external storage? May need mocking.
