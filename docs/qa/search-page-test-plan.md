# Test Plan: Roomshare Search Page

> Generated by QA Test Planner from Multi-Agent Simulation (5 specialists)

---

## Executive Summary

- **Feature**: Search Page — listing discovery with filters, map, pagination, ranking
- **Tech Stack**: Next.js SSR + PostGIS + MapLibre GL + Redis rate limiting + keyset pagination
- **Testing Objective**: Validate correctness, security, performance, and UX of all search flows
- **Key Risks**: XSS, full-table scan DoS, cursor tampering, IDOR, data parity (V1/V2)
- **Timeline**: Regression suite runs in ~45 min (smoke: 15 min)

---

## Agent Debate Summary (Multi-Agent Simulation)

### Participants & Findings

**Agent Alpha (Exploratory Tester)** — 10 attack vectors identified:
- Whitespace-only query bypassing bounds (HIGH)
- Cursor tampering with invalid base64 (HIGH)
- Emoji/Unicode in search query (MEDIUM)
- Array overflow: 51+ amenities (MEDIUM)
- Inverted price range: min > max (MEDIUM)
- Rapid filter toggling race conditions (MEDIUM)

**Agent Beta (UI/UX Critic)** — 10 visual concerns:
- Loading skeleton CLS mismatch (HIGH)
- Mobile filter sheet overflow (HIGH)
- Filter pill horizontal overflow with 10+ active (MEDIUM)
- Sort dropdown state persistence across pages (MEDIUM)

**Agent Gamma (Data Architect)** — 10 data integrity risks:
- Keyset cursor stability under concurrent inserts (HIGH)
- Facet counts vs actual result count mismatch (HIGH)
- V2 SearchDoc vs V1 Prisma query parity (HIGH)
- Price sort with null values — undefined position (MEDIUM)
- Hybrid count off-by-one at exactly 100 results (MEDIUM)

**Agent Delta (Performance Engineer)** — 10 perf concerns:
- Missing debounce/AbortController cancellation (HIGH)
- 3G network: >3s load time (HIGH)
- 10K+ listings in bounds: map clustering stress (HIGH)
- Map memory leak on persistent instance (MEDIUM)

**Agent Epsilon (Security Officer)** — 10 security threats:
- XSS via `q` parameter reflected in UI (HIGH/CRITICAL)
- Rate limit bypass under burst traffic (HIGH)
- Saved search IDOR (HIGH/CRITICAL)
- Inactive listing status leak via crafted params (HIGH)
- PII in debug rank output (MEDIUM)

### Synthesis: Top 10 Critical Scenarios (Prioritized)

| # | Scenario | Risk | Impact |
|---|----------|------|--------|
| 1 | XSS via `q` parameter reflected in UI | HIGH | Critical |
| 2 | Whitespace-only `q` bypassing bounds requirement | HIGH | DoS |
| 3 | Keyset cursor stability (no duplicates/gaps) | HIGH | Data integrity |
| 4 | Facet counts accuracy vs actual results | HIGH | User trust |
| 5 | Debounce + AbortController cancellation | HIGH | Cost + UX |
| 6 | Rate limiting enforcement under burst | HIGH | Abuse |
| 7 | Saved search authorization IDOR | LOW prob / CRITICAL impact | Privacy |
| 8 | Loading skeleton CLS | MEDIUM | Core Web Vitals |
| 9 | V2 SearchDoc vs V1 query parity | MEDIUM | Correctness |
| 10 | Invalid cursor crashes server | HIGH | Availability |

---

## Test Scope

### In Scope

| Area | Files | Test Types |
|------|-------|------------|
| Search parameter parsing & validation | `src/lib/search-params.ts`, `src/lib/constants.ts` | Unit |
| V2 API endpoint | `src/app/api/search/v2/route.ts` | Integration |
| Facets API | `src/app/api/search/facets/route.ts` | Integration |
| Search page SSR | `src/app/search/page.tsx` | E2E |
| Keyset pagination | `src/lib/search/search-doc-queries.ts` | Unit + Integration |
| Ranking algorithm | `src/lib/search/ranking/` | Unit |
| Map data (GeoJSON/pins) | V2 service + map components | E2E |
| Rate limiting | Redis-based limiter | Integration |
| Saved searches | Server actions + DB | Integration |
| Filter UI (mobile + desktop) | `src/components/search/` | E2E |

### Out of Scope

- MapLibre GL JS rendering internals (3rd party)
- Payment/booking flows triggered from search results
- Admin/moderation views of listings
- Search alerts cron job (separate test plan)

---

## Risk Assessment Matrix

| # | Scenario | Agent | Probability | Impact | Risk Score | Mitigation |
|---|----------|-------|-------------|--------|------------|------------|
| 1 | XSS via `q` param reflected in UI | Epsilon | Medium | Critical | **P0** | React auto-escapes; verify no raw HTML insertion |
| 2 | Whitespace `q` bypasses bounds requirement | Alpha | High | High | **P0** | `q.trim()` + `boundsRequired` check |
| 3 | Keyset cursor duplicates/gaps | Gamma | Medium | High | **P0** | Deterministic sort key + tie-breaking on ID |
| 4 | Facet counts != actual results | Gamma | Medium | High | **P1** | Same WHERE clause in facets + list queries |
| 5 | Missing debounce/AbortController | Delta | High | Medium | **P1** | Client-side cancellation pattern |
| 6 | Rate limit bypass under burst | Epsilon | Medium | High | **P1** | Redis sliding window; test with concurrent requests |
| 7 | Saved search IDOR | Epsilon | Low | Critical | **P0** | Auth check on all saved search endpoints |
| 8 | CLS from loading skeleton | Beta | Medium | Medium | **P1** | Skeleton matches card dimensions exactly |
| 9 | V2/V1 query parity | Gamma | Medium | High | **P1** | Run same params against both paths; compare |
| 10 | Invalid cursor crashes server | Alpha | High | Medium | **P1** | try/catch on cursor decode; return page 1 |

---

## Entry Criteria

- [x] Feature code merged to dev branch
- [x] Search V2 feature flag available (`ENABLE_SEARCH_V2`)
- [x] Test database seeded with >=100 listings across multiple locations
- [x] Redis running for rate limiting
- [x] PostGIS extension enabled

## Exit Criteria

- [ ] All P0 test cases pass (0 failures)
- [ ] >=95% P1 test cases pass
- [ ] No open Critical/High severity bugs
- [ ] Regression suite passes end-to-end
- [ ] CLS score < 0.1 on search page

---

## Test Environment

| Component | Specification |
|-----------|---------------|
| OS | Linux (CI), macOS/Windows (local dev) |
| Browsers | Chromium, Firefox, WebKit, Mobile Chrome (Pixel 5), Mobile Safari (iPhone 12) |
| Node.js | Per `package.json` engines |
| Database | PostgreSQL + PostGIS |
| Cache | Redis |
| Base URL | `http://localhost:3000` |

---

# Manual Test Cases

---

## TC-SEARCH-001: XSS via Query Parameter

**Priority:** P0 (Critical)
**Type:** Security
**Agent Source:** Epsilon

### Objective
Verify that script injection via the `q` search parameter is safely escaped in all UI rendering paths.

### Preconditions
- Search page accessible at `/search`
- Browser dev tools open (Console tab)

### Test Steps

1. Navigate to `/search?q=%3Cscript%3Ealert(%27xss%27)%3C/script%3E&minLat=37&maxLat=38&minLng=-123&maxLng=-122`
   **Expected:** Page renders normally. No alert dialog appears. Console shows 0 script errors. Query text displayed as literal escaped string in search bar.

2. Navigate to `/search?q=%3Cimg%20src%3Dx%20onerror%3Dalert(1)%3E&minLat=37&maxLat=38&minLng=-123&maxLng=-122`
   **Expected:** No alert dialog. No image element injected into DOM. Text rendered literally.

3. Navigate to `/search?q=javascript:alert(1)&minLat=37&maxLat=38&minLng=-123&maxLng=-122`
   **Expected:** Query treated as literal text. No JS execution.

4. Inspect the HTML source of the rendered page (View Source).
   **Expected:** Query value is HTML-entity-encoded, not raw HTML tags.

### Quantifiable Expected Results
- Alert dialogs triggered: **0**
- Console JS errors from injection: **0**
- Raw script/img tags in rendered DOM: **0**

---

## TC-SEARCH-002: Whitespace-Only Query Bypassing Bounds

**Priority:** P0 (Critical)
**Type:** Security / Data Protection
**Agent Source:** Alpha

### Objective
Verify that whitespace-only `q` values do not bypass the geographic bounds requirement, preventing full-table scans.

### Preconditions
- Database has >=1000 listings
- No geographic bounds provided

### Test Steps

1. Navigate to `/search?q=%20%20%20` (3 spaces, URL-encoded)
   **Expected:** `boundsRequired` flag is `true`. Page shows location prompt or zero results — NOT all 1000+ listings.

2. Navigate to `/search?q=%09%0A` (tab + newline)
   **Expected:** Same as step 1. Whitespace trimmed to empty query. Browse mode with <=48 results (MAX_UNBOUNDED_RESULTS).

3. Navigate to `/search?q=` (empty string)
   **Expected:** `browseMode: true`. Results capped at <=48 items.

4. Call `GET /api/search/v2?q=%20%20%20` directly.
   **Expected:** Response has `unboundedSearch: true` with `list: null, map: null`.

### Quantifiable Expected Results
- Results returned without bounds for whitespace query: **0** (or <=48 in browse mode)
- DB query execution time: **<200ms** (no full-table scan)
- `unboundedSearch` flag in API response: **true**

---

## TC-SEARCH-003: Keyset Cursor Stability

**Priority:** P0 (Critical)
**Type:** Data Integrity
**Agent Source:** Gamma

### Objective
Verify keyset pagination produces no duplicate or missing listings when data changes between page loads.

### Preconditions
- >=30 listings in a bounded area (3 pages at 12/page)
- Ability to insert a new listing between requests

### Test Steps

1. Load `/search?minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4&sort=newest`
   **Expected:** Page 1 shows 12 results. Response includes `nextCursor` value.

2. Record all 12 listing IDs from page 1.

3. Insert a new listing in the same bounds area (created_at = now).

4. Navigate to page 2 using the `nextCursor` from step 1.
   **Expected:** Page 2 shows 12 different listings. Zero overlap with page 1 IDs.

5. Collect all IDs from page 1 + page 2 + page 3.
   **Expected:** Union of all IDs has **0 duplicates**. Count = total listings in bounds (the newly inserted listing may appear on a reload of page 1).

### Quantifiable Expected Results
- Duplicate listing IDs across pages: **0**
- Missing listings (gap): **0** (except newly inserted, which appears on page 1 reload)
- Cursor decode errors: **0**

---

## TC-SEARCH-004: Facet Count Accuracy

**Priority:** P1 (High)
**Type:** Functional / Data Integrity
**Agent Source:** Gamma

### Objective
Verify `/api/search/facets` counts match actual search results when a filter is applied.

### Preconditions
- >=50 listings with varied amenities in SF bounds
- Facets endpoint accessible

### Test Steps

1. Call `GET /api/search/facets?minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** Response includes `amenities: { "Wifi": N, "Parking": M, ... }` where N, M > 0.

2. Record the count for "Wifi" (e.g., N=25).

3. Call `GET /api/search/v2?amenities=Wifi&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** `list.total` equals **exactly N** (25). Or if >100, `total` is null but first 100 results all have "Wifi" in amenities.

4. Repeat with `roomType=Private Room`.
   **Expected:** Result count matches facet count for "Private Room".

### Quantifiable Expected Results
- Facet count vs actual result count discrepancy: **0**
- Results missing the filtered amenity: **0**

---

## TC-SEARCH-005: Emoji Search Query

**Priority:** P2 (Medium)
**Type:** Functional / Edge Case
**Agent Source:** Alpha

### Objective
Verify emoji characters in the search query are handled gracefully without errors.

### Test Steps

1. Navigate to `/search?q=%F0%9F%8F%A0%F0%9F%94%A5&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** Page renders without error. Zero results or empty state shown. No 500 error.

2. Navigate to `/search?q=room%20%F0%9F%8F%A0&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** FTS processes "room" normally. Emoji ignored or treated as non-matching token. Results for "room" returned.

3. Check server logs.
   **Expected:** No unhandled exception. No PostgreSQL `tsquery` parse error.

### Quantifiable Expected Results
- HTTP 500 errors: **0**
- Server exceptions: **0**
- Page crash/white screen: **0**

---

## TC-SEARCH-006: Cursor Tampering (Invalid Base64)

**Priority:** P1 (High)
**Type:** Security / Robustness
**Agent Source:** Alpha

### Objective
Verify tampered or malformed cursor values do not crash the server.

### Test Steps

1. Navigate to `/search?cursor=INVALID_NOT_BASE64&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** Server returns page 1 results (fallback). HTTP status: **200**. No 500 error.

2. Navigate to `/search?cursor=eyJpZCI6Im5vbmV4aXN0ZW50In0=&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4` (valid base64, references non-existent listing)
   **Expected:** Returns page 1 results or empty page. HTTP status: **200**.

3. Navigate to `/search?cursor=%3Cscript%3Ealert(1)%3C/script%3E&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** Cursor rejected. Page 1 returned. No script execution.

4. Send cursor value exceeding 10KB.
   **Expected:** Rejected or truncated. No memory exhaustion. HTTP status: **200** or **400**.

### Quantifiable Expected Results
- HTTP 500 responses: **0**
- Server crashes: **0**
- Successful fallback to page 1: **100%** of tampered cursor cases

---

## TC-SEARCH-007: Null Price Sorting

**Priority:** P2 (Medium)
**Type:** Functional
**Agent Source:** Gamma

### Objective
Verify listings with null/undefined price are consistently positioned when sorting by price.

### Preconditions
- >=5 listings with price=null and >=5 with price set in same bounds

### Test Steps

1. Navigate to `/search?sort=price_asc&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** All priced listings appear sorted low-to-high. Null-price listings appear at the **end** (after all priced listings).

2. Navigate to `/search?sort=price_desc&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** All priced listings appear sorted high-to-low. Null-price listings appear at the **end**.

3. Navigate to page 2 of price_asc sort.
   **Expected:** Sort order maintained across pages. No null-price listing appears before a priced one.

### Quantifiable Expected Results
- Sort order violations (priced listing after null in asc): **0**
- Null-price listings mixed into sorted sequence: **0**

---

## TC-SEARCH-008: Inverted Price Range

**Priority:** P2 (Medium)
**Type:** Functional / Edge Case
**Agent Source:** Alpha

### Objective
Verify `minPrice > maxPrice` is handled without returning erroneous results.

### Test Steps

1. Navigate to `/search?minPrice=5000&maxPrice=100&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** Either (a) values auto-swapped (min=100, max=5000) and valid results returned, OR (b) zero results with no error.

2. Call `GET /api/search/v2?minPrice=5000&maxPrice=100&minLat=37.7&maxLat=37.8&minLng=-122.5&maxLng=-122.4`
   **Expected:** HTTP status: **200**. No 500 error. Response is valid JSON.

### Quantifiable Expected Results
- HTTP 500 errors: **0**
- Results with price outside any valid range: **0**

---

## TC-SEARCH-009: Array Overflow (21+ Amenities)

**Priority:** P2 (Medium)
**Type:** Security / Validation
**Agent Source:** Alpha

### Objective
Verify array parameters exceeding `MAX_ARRAY_ITEMS` (20) are truncated, not rejected with a crash.

### Test Steps

1. Construct URL with 21 amenities: `/search?amenities=Wifi&amenities=AC&amenities=Parking&...` (21 items total including invalid values)
   **Expected:** Only first 20 valid items used. Extra items silently dropped. Page renders normally.

2. Construct URL with 51 `houseRules` values (mix of valid and invalid).
   **Expected:** Capped at 20. Invalid values filtered out by allowlist. No error.

3. Call API directly with 100 amenities.
   **Expected:** HTTP **200**. Response valid. Query does not time out.

### Quantifiable Expected Results
- Array items processed beyond MAX_ARRAY_ITEMS (20): **0**
- HTTP 500 errors: **0**
- DB query with >20 array containment checks: **0**

---

## TC-SEARCH-010: Saved Search Authorization (IDOR)

**Priority:** P0 (Critical)
**Type:** Security
**Agent Source:** Epsilon

### Objective
Verify User A cannot access, modify, or delete User B's saved searches.

### Preconditions
- User A and User B both have saved searches
- Both users authenticated

### Test Steps

1. As User A, call `getMySavedSearches()`.
   **Expected:** Returns only User A's saved searches. Count matches User A's actual saves.

2. As User A, attempt to call `deleteSavedSearch(userB_savedSearch_id)`.
   **Expected:** Returns error/unauthorized. User B's saved search still exists.

3. As User A, attempt to call `toggleSearchAlert(userB_savedSearch_id)`.
   **Expected:** Returns error/unauthorized. User B's alert state unchanged.

4. As unauthenticated user, call `getMySavedSearches()`.
   **Expected:** Returns error/redirect to login. No data leaked.

### Quantifiable Expected Results
- Cross-user data access: **0** items
- Unauthorized mutations: **0** successful
- Unauthenticated data leaks: **0** items

---

# Regression Test Suite: Search Critical Paths

## Suite Overview

| Property | Value |
|----------|-------|
| Total Cases | 20 |
| P0 (must pass) | 8 |
| P1 (should pass) | 8 |
| P2 (nice to pass) | 4 |
| Estimated Duration | 45 minutes (smoke: 15 min) |
| Execution Order | Sequential (P0 first) |

## Smoke Tests (P0 — Run Every Build)

| ID | Test | Expected Result | Type |
|----|------|-----------------|------|
| REG-001 | Search page loads at `/search` | HTTP 200, >=1 listing card visible, 0 console errors | E2E |
| REG-002 | XSS in `q` param (script tag injection) | 0 alert dialogs, text escaped in DOM | E2E |
| REG-003 | Whitespace query without bounds | `boundsRequired: true` or <=48 browse results | Unit + E2E |
| REG-004 | Keyset cursor — page 2 has 0 duplicates from page 1 | Intersection of page 1 and page 2 ID sets = empty set | Integration |
| REG-005 | Invalid cursor falls back to page 1 | HTTP 200, valid results, 0 server errors | Integration |
| REG-006 | Rate limiting — 50 requests in 10s | >=1 request returns HTTP 429 | Integration |
| REG-007 | Saved search IDOR — cross-user access blocked | 0 cross-user items returned | Integration |
| REG-008 | V2 API returns valid `SearchV2Response` shape | `meta.mode` in {geojson, pins}, `list.items` is array | Integration |

## Core Regression (P1 — Run Before Release)

| ID | Test | Expected Result | Type |
|----|------|-----------------|------|
| REG-009 | Price filter: `minPrice=500&maxPrice=2000` | All results have price in [500, 2000] | E2E |
| REG-010 | Amenity filter: `amenities=Wifi` | All results include "Wifi" in amenities array | E2E |
| REG-011 | Sort: `price_asc` | Results ordered by price ascending; nulls at end | E2E |
| REG-012 | Sort: `newest` | Results ordered by `createdAt` descending | E2E |
| REG-013 | Facet counts match actual results for top 3 amenities | Facet N = result count when filtering by that amenity | Integration |
| REG-014 | Mobile filter sheet opens/closes | Sheet visible on tap, dismisses on close/back | E2E (Mobile Chrome) |
| REG-015 | Loading skeleton to real cards (no CLS) | CLS delta < 0.1 measured via PerformanceObserver | E2E |
| REG-016 | V2 SearchDoc vs V1 Prisma return same listing IDs | Set difference of V1 vs V2 results for same params = empty | Integration |

## Extended Regression (P2 — Run Weekly)

| ID | Test | Expected Result | Type |
|----|------|-----------------|------|
| REG-017 | Emoji query (house emoji) | HTTP 200, 0 server errors, page renders | E2E |
| REG-018 | 21 amenities in URL (exceeds MAX_ARRAY_ITEMS=20) | Only 20 processed, page renders normally | Unit |
| REG-019 | Inverted price range `minPrice=5000&maxPrice=100` | HTTP 200, 0 invalid results | Integration |
| REG-020 | Antimeridian bounds `minLng=179&maxLng=-179` | Results from date-line-crossing area returned correctly | Integration |

## Pass/Fail Criteria

**PASS (Release)**:
- All 8 P0 smoke tests pass
- >=7/8 P1 tests pass (>=87.5%)
- No Critical/High severity bugs open

**FAIL (Block Release)**:
- Any P0 test fails
- >=2 P1 tests fail
- Any security vulnerability (XSS, IDOR) discovered

**CONDITIONAL (Release with Known Issues)**:
- 1 P1 failure with documented workaround
- P2 failures with fix plan for next sprint

---

## Test Data Requirements

| Data | Quantity | Notes |
|------|----------|-------|
| Active listings in SF bounds | >=100 | Varied prices, amenities, room types |
| Listings with null price | >=5 | For null-sort testing |
| Listings with all amenities | >=2 | For intersection filter testing |
| Test users with saved searches | 2 | For IDOR testing |
| Listings near antimeridian | >=3 | For bounds edge case |

---

## Appendix: Key Constants Reference

| Constant | Value | Source |
|----------|-------|--------|
| `MAX_SAFE_PRICE` | 1,000,000,000 | `src/lib/constants.ts:13` |
| `MAX_SAFE_PAGE` | 100 | `src/lib/constants.ts:16` |
| `MAX_ARRAY_ITEMS` | 20 | `src/lib/constants.ts:19` |
| `MIN_QUERY_LENGTH` | 2 | `src/lib/constants.ts:31` |
| `MAX_QUERY_LENGTH` | 200 | `src/lib/constants.ts:34` |
| `DEFAULT_PAGE_SIZE` | 12 | `src/lib/constants.ts:22` |
| `ITEMS_PER_PAGE` | 12 | `src/app/search/page.tsx:22` |
| Cache TTL (V2 API) | s-maxage=60, max-age=30 | `src/app/api/search/v2/route.ts:107` |
| Valid amenities | Wifi, AC, Parking, Washer, Dryer, Kitchen, Gym, Pool, Furnished | `src/lib/search-params.ts:112` |
| Valid sort options | recommended, price_asc, price_desc, newest, rating | `src/lib/search-params.ts:183` |
| Valid room types | any, Private Room, Shared Room, Entire Place | `src/lib/search-params.ts:151` |
| Valid lease durations | any, Month-to-month, 3 months, 6 months, 12 months, Flexible | `src/lib/search-params.ts:129` |
